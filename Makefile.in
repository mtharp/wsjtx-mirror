# Makefile for Linux
# Re-direct stdout and stderr:		bash
#								make >& junk
#
# Prerequisites: Python 3.x, Portaudio, Samplerate, FFTW

# Program Infomation
PROGRAM		:=	@PROGRAM@
VERSION		:=	@VERSION@
COPYRIGHT	:=	@COPYRIGHT@
BUGS		:=	@BUGS@
WEB         :=	@WEB@

# System Information
OS			:=	@OS@
CPU			:=	@CPU@

# General Use Tools
AR			:=	@AR@
CP			:=	@CP@
LN			:=	@LN@
MV			:=	@MV@
RM			:=	@RM@
CHOWN		:=	@CHOWN@
CHMOD		:=	@CHMOD@
SHELL		:=	@SHELL@
MKDIR		:=	@MKDIR@ -p

# Install locations
INSTALL		:=	install
PREFIX		:=	@PREFIX@
BINDIR		:=	@BINDIR@
DOCDIR		:=	@DOCDIR@
HOMEDIR		:=	@HOMEDIR@
MANDIR		:=	@MANDIR@
SHARED		:=	@SHARED@
WSPRLIB		:=	@WSPRLIB@

# Compiler Information
CC			:=	@CC@
FC			:=	@FC@
FCV			:=	@FCV@
FC_LIB_PATH	+=	@FC_LIB_PATH@

# Python Information
PYTHON3		:=	@PYTHON3@
F2PY		:=	@F2PY@

# Libs and Flags
LIBS		:=	@LIBS@
LIBDIR      +=	@LIBDIR@
CPPFLAGS	+=	${DEFS}
CFLAGS		+=	@CFLAGS@
FFLAGS		+=	@FFLAGS@
LDFLAGS		+=	@LDFLAGS@
FCOPT		+=	@FCOPT@
PORTAUDIO_INCLUDE = 	@PORTAUDIO_INCLUDE@
PORTAUDIO_LIBDIR =	@PORTAUDIO_LIBDIR@

# Config Definitions
DEFS		:=	@DEFS@

# ALL WSPR Targets
all:	libfmt.a fmtest fmtave fcal fmeasure mkmsg

# Default Rules
%.o: %.c
	$(CC) $(PORTAUDIO_INCLUDE) $(CFLAGS) $(CPPFLAGS) -c $<
%.o: %.f
	$(FC) $(PORTAUDIO_INCLUDE) $(FFLAGS) -c $<
%.o: %.F
	$(FC) $(PORTAUDIO_INCLUDE) $(FFLAGS) -c $<
%.o: %.f90
	$(FC) $(PORTAUDIO_INCLUDE) $(FFLAGS) -c $<
%.o: %.F90
	${FC} $(PORTAUDIO_INCLUDE) $(FFLAGS) -c $<

OBJS1 = audiodev.o db.o fil1.o four2a.o padevsub.o peakup.o \
	sound.o xfft.o 

# build libfmt.a
libfmt.a: $(OBJS1) acom1.f90 acom2.f90
	@echo
	@echo Build libfmt library
	@echo -----------------------------
	$(AR) cr libfmt.a $(OBJS1)
	ranlib libfmt.a

# buid fmtest
fmtest: fmtest.f90 libfmt.a
	@echo
	@echo Build Fmtest
	@echo --------------------
	$(FC) $(PORTAUDIO_LIBDIR) $(LDFLAGS) -o fmtest fmtest.f90 libfmt.a -lfftw3f -lportaudio

# build fmtave
fmtave: fmtave.f90
	@echo
	@echo Build Fmtave
	@echo --------------------
	$(FC) $(LDFLAGS) -o fmtave fmtave.f90

# build fcal
fcal: fcal.f90
	@echo
	@echo Build Fcal
	@echo --------------------
	$(FC) $(LDFLAGS) -o fcal fcal.f90

# build fmeasure
fmeasure: fmeasure.f90
	@echo
	@echo Build Fmeasure
	@echo --------------------
	$(FC) $(LDFLAGS) -o fmeasure fmeasure.f90

# make summary message
mkmsg:
	@echo ''
	@echo '---------------------------------------------'
	@echo "$(PROGRAM) Make Summary"
	@echo '---------------------------------------------'
	@echo ''
	@echo "Package ..........: $(PROGRAM) $(VERSION)"
	@echo " Install prefix ..: $(PREFIX)"
	@echo ''
	@echo 'INSTALL'
	@echo ' Type ,,,,,,,,,,,.: make install'
	@echo ''

# install PyFMT
install:
	@echo
	@echo INSTALLING $(PROGRAM) $(VERSION)
	@echo ----------------------------
	@$(MKDIR) ./install
	@echo "..Installing Binaries"
	@$(INSTALL) -m 755 fmtest fcal fmeasure fmtave ./install
	@$(INSTALL) -m 755 libfmt.a ./install
	@echo '..Installing Python Related Files'
	@$(INSTALL) -m 755 modfmt/* ./install
	@echo '..Installing Misc. Files'
	@$(INSTALL) -m 755 examples/* ./install

# Cleanup Source Tree
.PHONY: clean distclean dist
clean :
	$(RM) -f *.o libfmt.a
	$(RM) -f ./{fmtest,fmtave,fcal,fmeasure}

distclean: clean
	$(RM) -f config.log config.status autoscan.log configure.scan Makefile \
	configure
	$(RM) -rf ./autom4* Makefile configure
	$(RM) -rf ./install
